<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Check In - Equipment Kiosk</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .secondary-button.loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img class="logo" src="{{ url_for('static', filename='images/logo.png') }}" alt="Organization Logo">
            <div class="header-text">Equipment Management</div>
        </div>
        <div class="header-right">
            <a href="{{ url_for('assets_bp.checkout_page') }}" class="cart-button">
                Cart <span class="cart-count">0</span>
            </a>
            <div id="logoutTimer" class="logout-timer">Session: 2:00</div>
            <a href="{{ url_for('auth_bp.logout') }}" class="logout-button">Logout</a>
        </div>
    </div>
    <main>
        <div class="center-container">
            <div class="main-title">Check In Equipment</div>
            <div class="instructions">Scan the equipment's barcode to return it</div>
            <div class="input-container">
                <input type="text" id="barcodeInput" style="position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0;" autocomplete="off" tabindex="-1">
                <div class="barcode-area">
                    <img src="{{ url_for('static', filename='images/tablet_clean.png') }}" alt="Equipment Check-in" class="scan-image">
                    <div class="scan-line"></div>
                </div>
            </div>
            
            <div class="alternative-entry" style="margin-top: 30px; text-align: center;">
                <div style="font-size: 14px; color: #666; margin-bottom: 10px;">or enter iPad asset tag number</div>
                <input type="text" id="assetTagInput" placeholder="iPad Asset Tag" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 200px; text-align: center; display: none;" autocomplete="off">
                <button id="toggleAssetTagInput" style="background: #f47142; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px;">Manual Entry</button>
            </div>
            <div id="feedback" class="feedback-message"></div>
            <div class="button-container">
                <a href="{{ url_for('assets_bp.dashboard') }}" class="secondary-button" id="backToDashboard">
                    <span class="button-text">Back to Dashboard</span>
                    <span class="loading-spinner" style="display: none;">Loading...</span>
                </a>
            </div>
        </div>
    </main>

    <script>
        const barcodeInput = document.getElementById('barcodeInput');
        const feedback = document.getElementById('feedback');
        const logoutTimer = document.getElementById('logoutTimer');
        let timer = null;
        let sessionTimeout = 120; // 2 minutes in seconds

        // Session timer
        function updateTimer() {
            const minutes = Math.floor(sessionTimeout / 60);
            const seconds = sessionTimeout % 60;
            logoutTimer.textContent = `Session: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (sessionTimeout <= 0) {
                clearCart(); // Clear cart before redirecting
                window.location.href = "{{ url_for('auth_bp.logout') }}";
            } else {
                sessionTimeout--;
            }
        }

        setInterval(updateTimer, 1000);

        // Reset timer on any activity
        document.addEventListener('mousemove', () => {
            sessionTimeout = 120;
        });
        document.addEventListener('keypress', () => {
            sessionTimeout = 120;
        });

        // Input field is hidden for barcode scanners only
        console.log('Checkin page loaded, setting up barcode input');
        
        // Asset tag manual entry functionality
        const assetTagInput = document.getElementById('assetTagInput');
        const toggleAssetTagButton = document.getElementById('toggleAssetTagInput');
        
        toggleAssetTagButton.addEventListener('click', () => {
            if (assetTagInput.style.display === 'none') {
                assetTagInput.style.display = 'inline-block';
                toggleAssetTagButton.textContent = 'Hide';
                assetTagInput.focus();
            } else {
                assetTagInput.style.display = 'none';
                toggleAssetTagButton.textContent = 'Manual Entry';
            }
        });
        
        assetTagInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const assetTag = e.target.value.trim();
                if (assetTag) {
                    processBarcodeInput(assetTag);
                    e.target.value = '';
                }
            }
        });
        

        // Handle barcode input from scanners
        barcodeInput.addEventListener('input', (e) => {
            console.log('Input received:', e.target.value);
            clearTimeout(timer);
            timer = setTimeout(() => {
                const barcode = e.target.value.trim();
                console.log('Processing barcode:', barcode, 'Length:', barcode.length);
                if (barcode) {
                    processBarcodeInput(barcode);
                    e.target.value = ''; // Clear the input
                }
            }, 100); // Small delay to ensure we get the complete barcode
        });

        // Function to handle the barcode input
        function processBarcodeInput(barcode) {
            feedback.textContent = 'Processing...';
            feedback.className = 'feedback-message processing';
            
            fetch("{{ url_for('assets_bp.process_asset_barcode') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 
                    barcode: barcode,
                    action: 'checkin'
                }),
            })
            .then(response => response.json())            .then(data => {
                if (data.success) {
                    feedback.textContent = data.message || 'Equipment checked in successfully!';
                    feedback.className = 'feedback-message success';
                    
                    // Keep the success message visible for 3 seconds
                    setTimeout(() => {
                        feedback.textContent = '';
                        feedback.className = 'feedback-message';
                    }, 3000);
                    
                    if (data.redirect) {
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 1500); // Redirect after 1.5 seconds so user can see success message
                    }
                } else {
                    feedback.textContent = data.error || 'Error processing equipment.';
                    feedback.className = 'feedback-message error';
                    barcodeInput.focus(); // Refocus for next attempt
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                feedback.textContent = 'Error processing equipment.';
                feedback.className = 'feedback-message error';
                barcodeInput.focus(); // Refocus for next attempt
            });
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            // Focus removed for touch-friendly experience
            updateCartCount();
        });

        // Update cart count from localStorage
        function updateCartCount() {
            const cartCount = localStorage.getItem('cartCount') || '0';
            document.querySelector('.cart-count').textContent = cartCount;
        }

        // Update cart count when localStorage changes
        window.addEventListener('storage', updateCartCount);

        function clearCart() {
            localStorage.removeItem('equipmentCart');
            localStorage.removeItem('cartCount');
            document.querySelector('.cart-count').textContent = '0';
        }

        // Clear cart when logging out
        document.querySelector('.logout-button').addEventListener('click', clearCart);

        // Add loading indicator to Back to Dashboard button
        document.getElementById('backToDashboard').addEventListener('click', function(e) {
            const button = this;
            const buttonText = button.querySelector('.button-text');
            const loadingSpinner = button.querySelector('.loading-spinner');
            
            // Show loading state
            buttonText.style.display = 'none';
            loadingSpinner.style.display = 'inline';
            button.classList.add('loading');
            
            // Don't prevent the default navigation
            // The loading state will show while the page loads
        });
    </script>
</body>
</html>
