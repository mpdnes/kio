<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Equipment Information - Equipment Kiosk</title>
    <link href="https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img class="logo" src="{{ url_for('static', filename='images/logo.png') }}" alt="Organization Logo">
            <div class="header-text">Equipment Management</div>
        </div>
    </div>
    <main>
        <div class="center-container">
            <div class="main-title">View Equipment Information</div>
            <div class="instructions">Scan the equipment's barcode to view its information</div>
            <div class="input-container">
                <input type="text" id="barcodeInput" style="position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0;" autocomplete="off" tabindex="-1">
                <div class="barcode-area">
                    <img src="{{ url_for('static', filename='images/tablet_clean.png') }}" alt="Equipment Information" class="scan-image">
                    <div class="scan-line"></div>
                </div>
            </div>
            <div id="assetInfo" style="display: none;" class="asset-info-container"></div>
            <div id="feedback" class="feedback-message"></div>
            <div class="button-container">
                <a href="{{ url_for('main_bp.home') }}" class="secondary-button">Back to Home</a>
            </div>
        </div>
    </main>

    <script>
        const barcodeInput = document.getElementById('barcodeInput');
        const feedback = document.getElementById('feedback');
        const assetInfo = document.getElementById('assetInfo');
        let timer = null;

        // Input field is hidden for barcode scanners only
        console.log('Public equipment info page loaded, setting up barcode input');
        
        // Keep input focused for barcode scanners
        setInterval(() => {
            if (document.activeElement !== barcodeInput) {
                barcodeInput.focus();
            }
        }, 1000);

        // Handle barcode input from scanners
        barcodeInput.addEventListener('input', (e) => {
            console.log('Input received:', e.target.value);
            clearTimeout(timer);
            timer = setTimeout(() => {
                const barcode = e.target.value.trim();
                console.log('Processing barcode:', barcode, 'Length:', barcode.length);
                if (barcode) {
                    processBarcodeInput(barcode);
                    e.target.value = ''; // Clear the input
                }
            }, 100); // Small delay to ensure we get the complete barcode
        });

        // Function to display asset information
        function displayAssetInfo(data) {
            assetInfo.style.display = 'block';
            
            // Determine if asset is checked out and by whom
            const isCheckedOut = data.status_label?.status_meta === 'deployed' || data.assigned_to;
            const assignedToInfo = data.assigned_to ? data.assigned_to.name : 'Unknown User';
            
            assetInfo.innerHTML = `
                <div class="asset-card">
                    <div class="asset-name">${data.name || (data.model?.name) || `Asset ${data.asset_tag}` || 'N/A'}</div>
                    <div class="asset-tag">Inventory: ${data.inventory_number || data.asset_tag || 'N/A'}</div>
                    <div class="asset-status">Status: ${data.status_label?.name || 'N/A'}</div>
                    ${isCheckedOut ? 
                        `<div class="asset-assigned" style="color: #ff6b6b; font-weight: bold;">
                            ⚠️ CHECKED OUT to: ${assignedToInfo}
                        </div>` : 
                        `<div class="asset-available" style="color: #51cf66; font-weight: bold;">
                            ✅ Available for checkout
                        </div>`
                    }
                    ${data.model ? `<div class="asset-model">Model: ${data.model.name}</div>` : ''}
                    ${data.serial ? `<div class="asset-serial">Serial: ${data.serial}</div>` : ''}
                </div>
            `;
        }

        // Function to handle the barcode input
        function processBarcodeInput(barcode) {
            feedback.textContent = 'Processing...';
            feedback.className = 'feedback-message';
            assetInfo.style.display = 'none';
            
            fetch("{{ url_for('assets_bp.public_asset_info', barcode='PLACEHOLDER') }}".replace('PLACEHOLDER', barcode), {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    feedback.textContent = 'Equipment information retrieved successfully.';
                    feedback.className = 'feedback-message success';
                    displayAssetInfo(data.data);
                } else {
                    feedback.textContent = data.error;
                    feedback.className = 'feedback-message error';
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                feedback.textContent = 'Error retrieving equipment information.';
                feedback.className = 'feedback-message error';
            });
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            // Focus for barcode scanner functionality
            barcodeInput.focus();
        });
    </script>
</body>
</html>